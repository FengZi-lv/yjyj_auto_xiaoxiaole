# 永劫无间消消乐自动化脚本

本项目在 Windows 上通过模板匹配识别 6x6 棋盘，并使用 Arduino 作为 USB HID 设备执行鼠标移动与点击，自动完成“相邻交换→达成三连→等待动画结束”的循环。
````markdown
# yjyj_auto_xiaoxiaole
自动完成永劫无间的消消乐游戏

## 简介

本项目在 Windows 上通过模板匹配识别 6x6 棋盘，并使用 Arduino 作为 USB HID 设备执行鼠标移动与点击，自动完成“相邻交换→达成三连→等待动画结束”的循环。

---

## 1. 环境准备
- 操作系统：Windows（PowerShell）
- Python：3.9+（推荐）
- 依赖：OpenCV、NumPy、mss、Pillow、keyboard、pyserial、pyautogui、scikit-image

> 建议使用虚拟环境（以下命令将使用Venv）

```powershell
python -m venv venv
# 此处需要激活你的虚拟环境，例如Windows为运行`venv\Scripts\Activate.ps1`
pip install -r requirements.txt
```
> 如遇 `cv2` 或 `pyautogui` 无法导入，请确认你使用的 Python 解释器正确，并重新执行安装。

---

## 2. Arduino 烧录与连接
1) 硬件要求：支持 USB HID 的开发板（如 Arduino Leonardo、Micro、Pro Micro、Teensy 等）。UNO/R3 这类无原生 USB 的板不能直接使用 `Mouse.h`。
2) 打开 Arduino IDE，载入项目根目录下的 `arduino_auto_click.ino`。
3) 选择开发板与端口：
    - 菜单 “工具 -> 开发板” 选择你的板卡（如“Arduino Leonardo”）。
    - 菜单 “工具 -> 端口” 选择对应的 COM 口。
4) 点击“上传”进行烧录。
5) 烧录成功后，板子会作为 HID 设备出现，同时暴露一个串口（波特率 115200）。

串口指令协议（由 Python 发送）：
- `M dx dy\n`：相对移动光标 dx、dy 像素（固件内已做小批次分步，尽量避免加速度误差）。
- `c\n`：执行一次左键短按点击。
> 若鼠标移动距离仍有偏差，可在固件中将 `batch_step` 改小（更精确但更慢），或关闭系统“增强指针精确度”。

---

## 3. 模板准备（识别 4 种色块）
- 在 `templates/` 目录放入 4 张 PNG，每张对应一种色块外观（名称不限，最好是 `R.png / Y.png / P.png / B.png`，因为会有多彩输出，详见`main.COLOR_MAP`）。
- 模板尺寸不必一致，识别时会自动缩放；建议裁剪得尽量紧凑，避免过多背景。(如示例图)

---

## 4. 首次运行与标定
运行：
```powershell
python main.py
```
首次运行会：
- 列出可用串口，按提示选择编号；选择将写入 `config.json`（与程序同目录）。
- 使用热键标定两个区域：
    - 棋盘区域（左上、右下）：依次移动鼠标到棋盘左上角按下 `Ctrl+Alt+S`，再移动到棋盘右下角按 `Ctrl+Alt+E`。
    - 分数区域（左上、右下）：移动到“当前绮念”分数显示区域左上角按 `Ctrl+Alt+F`，再到右下角按 `Ctrl+Alt+G`。
- 标定完成后进入主循环。

热键一览：
- 棋盘左上：`Ctrl+Alt+S`
- 棋盘右下：`Ctrl+Alt+E`
- 分数区左上：`Ctrl+Alt+F`
- 分数区右下：`Ctrl+Alt+G`
- 退出：`F8`
> 程序只有在区域“宽高>0”的情况下才会开始运行，避免只设置了左上角就误判完成。

`config.json` 会保存：
```json
{
    "board_region": [left, top, right, bottom],
    "score_region": [left, top, right, bottom],
    "serial_port": "COMx"
}
```
如需重新标定或更换串口，删除该文件后重启程序。

---

## 5. 运行过程与输出
- 每次迭代：截图 → 模板识别 → 计算最佳交换 → 通过 Arduino 移动并点击两次 → 监测分数区域稳定后进入下一轮。
- 控制台输出：
    - `[INFO]` 一般信息
    - `[STEP]` 当前步骤（包含棋盘彩色打印、待交换格子的下划线高亮、坐标、串口状态等）
    - `[WARN]` 警告（低置信度、串口失败、分数区长时间不稳定）
    - `[ERROR]` 错误（模板不足、区域未设置）
- 棋盘打印采用 ANSI 颜色，不同模板名可对应不同颜色（例如 `R/Y/P/B`）。

等待动画结束的判定：
- 程序对分数区域进行多帧像素差比较，若在设定时间内变化趋于稳定，即认为新块已下落完成。
- 相关阈值可在 `config.py` 调整：`wait_score_stable_seconds`, `score_stable_checks`, `score_diff_threshold`。

---

## 6. 常见问题排查（FAQ）
- 导入 `cv2`/`pyautogui` 失败：请确认已执行 `pip install -r requirements.txt`，或检查是否在虚拟环境内。
- 串口未列出：安装对应板子的驱动，或更换数据线/USB口；确认板子已成功烧录。
- 鼠标移动偏差：
    1) 试着减小 `arduino_auto_click.ino` 内的 `batch_step`（更细粒度移动）。
    2) 关闭系统“增强指针精确度”。
- 点击偏边缘：程序已基于模板内容估算点击中心（前景质心）。若仍偏，可优化模板裁剪，让图案更居中、背景更少。
- 无可行交换：脚本将提示并退出；此时可手动刷新或重新开始。

---

## 7. 目录结构
```
AutoXiaoXiaoLe/
├─ main.py                # 入口，循环控制与日志输出
├─ actions.py             # 串口移动/点击实现
├─ detection.py           # 区域管理、截图与识别、分数稳定检测
├─ solver.py              # 最佳交换求解
├─ templates.py           # 模板加载与匹配
├─ config.py              # 运行配置（热键/阈值等）
├─ arduino_auto_click.ino # Arduino 固件（Mouse 移动+点击）
├─ templates/             # 放置 4 个色块模板 PNG
└─ requirements.txt
```

---

## 8. 进阶配置（可选）
- `config.py` 可调整：
    - `min_confidence`/`retry_low_conf`：低置信度重试策略。
    - `swap_click_interval`：两次点击间隔。
    - `hotkey_*`：热键自定义。
- 如需完全禁止本机点击回退（仅允许 Arduino 点击），可在 `actions.py` 移除 `_pc_click()` 的调用（如需我可以代改）。

---

## 9. 免责声明

- 本项目仅用于技术研究与学习演示：旨在展示模板匹配、屏幕识别与外设自动化控制等通用技术，不鼓励也不支持将其用于任何违反游戏、平台或设备使用条款的场景。
- 账户与封禁风险：大多数网络游戏/平台禁止第三方自动化。使用本项目可能触发风控、封禁、限权等后果；所有风险与损失由使用者自行承担。
- 合法合规义务：使用者必须自行确认并遵守所在司法辖区的法律法规、目标游戏/平台/设备的服务条款与公平使用政策。若不符合，请立即停止使用。
- 使用范围建议：仅在离线/单机/允许自动化的环境中使用；不得用于竞技、对抗或影响他人公平性的场景。
- 第三方与硬件风险：本项目依赖的第三方库与 Arduino 等硬件由其各自提供者维护。安装与使用可能带来系统不稳定、设备异常、数据丢失等风险；请在隔离与可回滚环境中操作，并自行承担相关后果。
- 数据与隐私：运行过程中可能截取屏幕图像并处理其中的可见信息。请勿在包含敏感/个人数据的界面使用，或将相关数据对外共享。
- 无担保条款：本项目按“现状”提供，不提供任何明示或默示的保证（包括但不限于适销性、特定用途适用性、稳定性与无侵权）。作者与贡献者不对由此引发的直接或间接损失负责。
- 责任限制：在任何情况下，作者与贡献者均不对使用、无法使用或性能问题造成的任何损害（包括但不限于利润/商誉/数据损失或其他间接、附带、特殊、惩罚性损害）承担责任。
- 使用即视为同意：下载、构建、运行或修改本项目即表示你已阅读、理解并同意本免责声明及相关条款。如不同意，请勿使用本项目。
````

